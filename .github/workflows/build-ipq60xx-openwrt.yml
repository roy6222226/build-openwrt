name: build ipq60xx openwrt

on:
  workflow_dispatch:
    inputs:
      source:
        description: '选择要编译的源码'
        required: true
        default: 'immwrt'
        type: choice
        options: ['immwrt']
      target:
        description: '选择要编译的机型'
        required: true
        default: 'ipq60xx'
        type: choice
        options: ['ipq60xx']
      ip_address:
        description: '设置默认IP地址'
        required: false
        default: '192.168.1.1'
      wifi:
        description: '选择是否编译WIFI'
        required: false
        default: 'wifi-yes'
        type: choice
        options: ['wifi-yes', 'wifi-no']
      openclash:
        description: '预设openclash内核'
        required: false
        default: 'arm64'
        type: choice
        options: [false, amd64, arm64, armv7]
      toolchain:
        description: '是否重新编译 Toolchain (False=使用缓存或默认)'
        required: false
        default: false
        type: boolean
      artifact:
        description: '上传固件到Artifact'
        required: false
        default: true
        type: boolean
      release:
        description: '上传固件到Releases'
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: build ${{inputs.target}} ${{inputs.wifi}}
    # 建议使用 22.04 以保证编译成功率，24.04 可能有依赖问题
    runs-on: ubuntu-22.04

    env:
      REPO_URL: https://github.com/immortalwrt/immortalwrt
      REPO_BRANCH: master
      IP_ADDRESS: ${{inputs.ip_address}}
      CLASH_KERNEL: ${{inputs.openclash}}
      # 将输入的 boolean 映射到环境变量，注意 shell 脚本中 true/false 字符串处理
      REBUILD_TOOLCHAIN: ${{inputs.toolchain}} 
      CONFIG_FILE: configs/${{inputs.target}}-${{inputs.wifi}}.config
      DIY_SCRIPT: ${{inputs.source}}.sh
      RELEASE_TAG: ${{inputs.target}}-${{inputs.wifi}}
      UPLOAD_BIN_DIR: false
      UPLOAD_ARTIFACT: ${{inputs.artifact}}
      UPLOAD_RELEASE: ${{inputs.release}}
      TZ: Asia/Shanghai

    steps:
      - name: Checkout Helper Scripts
        uses: actions/checkout@v4

      - name: Check Server Performance
        run: |
          echo "==========================CPU信息=========================="
          echo "CPU物理数量: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "CPU线程数量: $(nproc)"

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi -f $(docker images -q) 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android $AGENT_TOOLSDIRECTORY
          sudo -E apt -yqq update
          sudo -E apt -yqq install $(curl -fsSL is.gd/depends_ubuntu_2204)
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq clean
          sudo timedatectl set-timezone "$TZ"

      # 磁盘扩容步骤保留，但在 Ubuntu 22.04/24.04 上需谨慎，若非必要可注释掉
      - name: Combine Disks
        run: |
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Clone Source Code
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          # 设置全局环境变量 OPENWRT_PATH
          echo "OPENWRT_PATH=/workdir/openwrt" >> $GITHUB_ENV

      - name: Load Custom Script
        run: |
          # 确保脚本存在
          if [ -f "$DIY_SCRIPT" ]; then
             chmod +x $DIY_SCRIPT
             cd $OPENWRT_PATH
             $GITHUB_WORKSPACE/$DIY_SCRIPT
          else
             echo "Script $DIY_SCRIPT not found, skipping."
          fi

      - name: Update Feeds
        run: |
          cd $OPENWRT_PATH
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load Config
        run: |
          [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          # 如果需要修改默认IP
          sed -i 's/192.168.1.1/${{env.IP_ADDRESS}}/g' package/base-files/files/bin/config_generate
          
          # 生成完整配置
          make defconfig

      - name: Download DL Package
        run: |
          cd $OPENWRT_PATH
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        id: compile
        run: |
          cd $OPENWRT_PATH
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
          echo "DATE=$(date +"%Y.%m.%d-%H:%M:%S")" >> $GITHUB_ENV

      - name: Organize Files
        if: steps.compile.conclusion == 'success'
        run: |
          cd $OPENWRT_PATH/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: Upload Firmware To Artifact
        if: steps.compile.conclusion == 'success' && env.UPLOAD_ARTIFACT == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.RELEASE_TAG}}-${{env.FILE_DATE}}
          path: ${{env.FIRMWARE_PATH}}

      - name: Upload Firmware To Release
        if: steps.compile.conclusion == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{env.RELEASE_TAG}}-${{env.FILE_DATE}}
          files: ${{env.FIRMWARE_PATH}}/*
          body: |
            Target: ${{env.RELEASE_TAG}}
            IP: ${{env.IP_ADDRESS}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
